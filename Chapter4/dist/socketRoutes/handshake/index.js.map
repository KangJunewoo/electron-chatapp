{"version":3,"sources":["../../../socketRoutes/handshake/index.js"],"names":["module","exports","socket","next","User","require","jsonwebtoken","token","handshake","query","cert","console","log","verify","err","decodedUser","name","isExistNewToken","Error","findOne","id","then","user","catch","error"],"mappings":"AAAA;;;;;;AAMA;;AAEAA,OAAOC,OAAP,GAAiB,UAACC,MAAD,EAAQC,IAAR,EAAe;AAC9B,MAAMC,OAAMC,QAAQ,kBAAR,CAAZ;AACA,MAAMC,eAAeD,QAAQ,cAAR,CAArB;AACA,MAAME,QAAQL,OAAOM,SAAP,CAAiBC,KAAjB,CAAuBF,KAArC;AACA,MAAMG,OAAO,QAAb;AACAC,UAAQC,GAAR,eAAwBL,KAAxB;AACAD,eAAaO,MAAb,CAAoBN,KAApB,EAA0BG,IAA1B,EAA+B,UAACI,GAAD,EAAKC,WAAL,EAAmB;AAChD,QAAGD,GAAH,EAAO;AACL,UAAGA,IAAIE,IAAJ,KAAW,mBAAd,EAAkC;AAChCd,eAAOe,eAAP,GAAyB,IAAzB;AACA,eAAOd,MAAP;AACD,OAHD,MAGK;AACH,eAAOA,KAAK,IAAIe,KAAJ,CAAU,cAAV,CAAL,CAAP;AACD;AACF;AACDd,SAAKe,OAAL,CAAa,EAACC,IAAGL,YAAYK,EAAhB,EAAb,EACGC,IADH,CACQ,UAACC,IAAD,EAAQ;AACZ,UAAG,CAACA,IAAJ,EAAS;AACP,eAAOnB,KAAK,IAAIe,KAAJ,CAAU,cAAV,CAAL,CAAP;AACD;AACDI,WAAKf,KAAL,KAAaA,KAAb,GAAmBJ,MAAnB,GAA0BA,KAAK,IAAIe,KAAJ,CAAU,cAAV,CAAL,CAA1B;AACA;AACD,KAPH,EAQGK,KARH,CAQS,UAACC,KAAD,EAAS;AACd,aAAOrB,KAAK,IAAIe,KAAJ,CAAU,cAAV,CAAL,CAAP;AACD,KAVH;AAWD,GApBD;AAqBD,CA3BD","file":"index.js","sourcesContent":["/**\n * Created by kishe56@gmail.com on 2018. 9. 18.\n * Blog : https://kishe89.github.io\n * Github : https://github.com/kishe89\n */\n\n'use strict';\n\nmodule.exports = (socket,next)=>{\n  const User =require('../../model/User');\n  const jsonwebtoken = require('jsonwebtoken');\n  const token = socket.handshake.query.token;\n  const cert = \"secret\";\n  console.log(`token is ${token}`);\n  jsonwebtoken.verify(token,cert,(err,decodedUser)=>{\n    if(err){\n      if(err.name==='TokenExpiredError'){\n        socket.isExistNewToken = true;\n        return next();\n      }else{\n        return next(new Error('Unauthorized'));\n      }\n    }\n    User.findOne({id:decodedUser.id})\n      .then((user)=>{\n        if(!user){\n          return next(new Error('Unauthorized'));\n        }\n        user.token===token?next():next(new Error('Unauthorized'));\n        return;\n      })\n      .catch((error)=>{\n        return next(new Error('Unauthorized'));\n      });\n  });\n};"]}